<!-- src/main/resources/static/reviews1.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Reviews & Ratings</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; padding: 2rem; }
        .container { max-width: 900px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .header h2 { font-size: 2rem; font-weight: 700; margin: 0; }
        .controls { display: flex; gap: 0.5rem; }
        select, button { padding: 0.5rem; border: none; border-radius: 5px; cursor: pointer; }
        button { background: #000; color: #fff; }

        .card { background: #e8edf3; border-radius: 10px; padding: 1rem 1.5rem; margin-bottom: 1rem;
            display: flex; align-items: center; justify-content: space-between; position: relative;
            cursor: pointer; transition: box-shadow 0.3s; }
        .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .card.best { background: #fffae6; border: 2px solid #fbbf24; }

        .badge { position: absolute; top: -10px; left: -10px; background: orange; color: white;
            font-size: 0.75rem; font-weight: bold; padding: 0.2rem 0.6rem; border-radius: 50px; }
        .best-label { position: absolute; top: -12px; right: -12px; background: #fbbf24; color: #000;
            font-weight: bold; padding: 0.3rem 0.5rem; border-radius: 5px; font-size: 0.7rem; }

        .avatar { font-size: 2.5rem; }
        .info { flex: 1; margin-left: 1rem; }
        .name { font-weight: 600; font-size: 1.1rem; }
        .stars { color: gold; font-size: 1.2rem; }
        .meta { font-size: 0.9rem; color: #555; }
        .comment { font-style: italic; font-size: 0.9rem; color: #333; margin-top: 0.5rem; }

        .actions { text-align: right; display: flex; flex-direction: column; align-items: flex-end; }
        .bookmark { font-size: 1.2rem; color: #ccc; cursor: pointer; }
        .bookmark.favorited { color: red; }
        .profile-link { color: #fbbf24; font-weight: bold; margin-top: 0.4rem; }

        .pagination { display: flex; justify-content: space-between; margin-top: 2rem; }
        .pagination button { background: #ccc; color: #000; }
        .pagination button:disabled { background: #eee; cursor: not-allowed; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h2>REVIEWS &amp; <span style="font-weight: 900">RATINGS</span></h2>
        <div class="controls">
            <select id="starFilter">
                <option value="">All Ratings</option>
                <option value="5">5 Stars</option>
                <option value="4">4 Stars</option>
                <option value="3">3 Stars</option>
                <option value="2">2 Stars</option>
                <option value="1">1 Star</option>
            </select>
            <button id="sortBtn">Sort Desc</button>
        </div>
    </div>

    <div id="reviews"></div>

    <div class="pagination">
        <button id="prevPage">Previous</button>
        <button id="nextPage">Next</button>
    </div>
</div>

<script>
    const API_URL = '/api/reviews/best?limit=50';
    let technicians = [], currentPage = 1, itemsPerPage = 3;
    let sortAsc = false, ratingFilter = null;
    let favorites = new Set(JSON.parse(localStorage.getItem('favorites') || '[]'));

    async function fetchTechnicians() {
        // get top techs
        technicians = await (await fetch(API_URL)).json();
        // fetch all reviews per tech for comment rotation
        await Promise.all(technicians.map(async t => {
            const revs = await (await fetch(`/api/reviews/technician/${t.technicianId}`)).json();
            t.allComments = revs.map(r => r.comment).filter(c => c);
        }));
        renderTechnicians();
    }

    function renderTechnicians() {
        // copy & filter
        let data = technicians.slice();
        if (ratingFilter) {
            data = data.filter(t => Math.round(t.averageRating) === ratingFilter);
        }
        // sort
        data.sort((a,b)=>
            sortAsc ? a.averageRating - b.averageRating : b.averageRating - a.averageRating
        );
        // page slice
        const start = (currentPage - 1) * itemsPerPage;
        const pageTechs = data.slice(start, start + itemsPerPage);

        const container = document.getElementById('reviews');
        container.innerHTML = '';
        pageTechs.forEach((tech, idx) => {
            const isBest = (currentPage === 1 && idx === 0 && !ratingFilter && !sortAsc);
            const rounded = Math.round(tech.averageRating);
            const stars = '‚òÖ'.repeat(rounded) + '‚òÜ'.repeat(5 - rounded);
            // random rotate comment
            const comments = tech.allComments.length
                ? tech.allComments
                : [tech.latestComment || 'No reviews yet.'];
            const comment = comments[Math.floor(Math.random() * comments.length)];
            const reviewer = tech.latestReviewerName ? ` ‚Äî ${tech.latestReviewerName}` : '';
            const favClass = favorites.has(tech.technicianId) ? ' favorited' : '';

            const card = document.createElement('div');
            card.className = `card${isBest ? ' best' : ''}`;
            card.onclick = () => window.location.href = `/profile/${tech.technicianId}`;
            card.innerHTML = `
          ${isBest
                ? '<div class="badge">1</div><div class="best-label">BEST TECHNICIAN</div>'
                : ''}
          <div class="avatar">üë§</div>
          <div class="info">
            <div class="name">${tech.fullName}</div>
            <div class="stars">${stars}
              <span class="meta">(${tech.reviewCount} ratings)</span>
            </div>
            <div class="meta">Orders completed: ${tech.reviewCount}</div>
            <div class="comment">‚Äú${comment}${reviewer}‚Äù</div>
          </div>
          <div class="actions">
            <div class="bookmark${favClass}"
                 onclick="toggleFavorite(event,'${tech.technicianId}')">
              üîñ
            </div>
            <div class="profile-link">View Profile</div>
          </div>
        `;
            container.appendChild(card);
        });

        document.getElementById('prevPage').disabled = (currentPage === 1);
        document.getElementById('nextPage').disabled = (start + itemsPerPage >= data.length);
    }

    function toggleFavorite(e, id) {
        e.stopPropagation();
        if (favorites.has(id)) favorites.delete(id);
        else favorites.add(id);
        localStorage.setItem('favorites', JSON.stringify(Array.from(favorites)));
        renderTechnicians();
    }

    // controls
    document.getElementById('sortBtn')
        .addEventListener('click', () => {
            sortAsc = !sortAsc;
            document.getElementById('sortBtn').textContent = sortAsc ? 'Sort Asc' : 'Sort Desc';
            currentPage = 1;
            renderTechnicians();
        });

    document.getElementById('starFilter')
        .addEventListener('change', e => {
            ratingFilter = e.target.value ? +e.target.value : null;
            currentPage = 1;
            renderTechnicians();
        });

    document.getElementById('nextPage')
        .addEventListener('click', () => {
            currentPage++;
            renderTechnicians();
        });

    document.getElementById('prevPage')
        .addEventListener('click', () => {
            currentPage--;
            renderTechnicians();
        });

    // rotate comments every 5s
    setInterval(renderTechnicians, 5000);

    document.addEventListener('DOMContentLoaded', fetchTechnicians);
</script>
</body>
</html>